# 开发流程与任务分解
# Development Workflow v1.0

> **目标读者**: 项目管理者、全体开发者  
> **前置阅读**: `README.md`

---

## 开发阶段总览

本项目分为 4 个 Phase，预计总开发时间 **8-10 天**。

```
Phase 1 (3-4天) → Phase 2 (2-3天) → Phase 3 (2天) → Phase 4 (1-2天)
    ↓                  ↓                ↓              ↓
 数据+API          前端地图          交互功能        优化调试
```

---

## Phase 1: 数据准备与后端 API（3-4 天）

### 目标
✅ 完成数据清洗和聚合  
✅ 实现所有核心 API 端点  
✅ 通过 API 测试

### 任务清单

#### 1.1 数据收集（0.5 天）
- [ ] 获取新加坡 MRT/LRT 线路 GeoJSON 数据
- [ ] 获取公交线路 GeoJSON 数据（或生成模拟数据）
- [ ] 收集或生成客流量数据（真实数据或模拟）
- [ ] 整理站点信息 JSON

**资源**:
- LTA DataMall: https://datamall.lta.gov.sg/
- OpenStreetMap Singapore: https://www.openstreetmap.org/

#### 1.2 数据预处理（1 天）
- [ ] 编写 `scripts/preprocess.py`
- [ ] 清洗原始数据（删除缺失值、异常值）
- [ ] 按小时聚合客流数据
- [ ] 生成线路 JSON 文件
- [ ] 生成元数据 JSON 文件
- [ ] 验证数据质量（运行检查脚本）

**交付物**:
- `data/processed/flow_aggregated.parquet`
- `data/processed/routes.json`
- `data/processed/metadata.json`

#### 1.3 Flask 后端开发（1.5 天）
- [ ] 创建项目结构
- [ ] 实现 `config.py`
- [ ] 实现 `app.py` 主程序
- [ ] 实现 `/api/v1/health` 端点
- [ ] 实现 `/api/v1/metadata` 端点
- [ ] 实现 `/api/v1/routes` 端点
- [ ] 实现 `/api/v1/passenger-flow` 端点（核心）
- [ ] 配置 Flask-CORS

**交付物**:
- 完整的后端代码
- 可运行的 Flask 服务器

#### 1.4 API 测试（0.5 天）
- [ ] 使用 curl 测试所有端点
- [ ] 验证响应格式正确性
- [ ] 测试错误处理（缺少参数、无效参数）
- [ ] 性能测试（响应时间 < 500ms）
- [ ] 编写 `tests/test_api.py`

**验收标准**:
- 所有 API 端点正常响应
- 错误响应格式统一
- 响应时间满足要求

---

## Phase 2: 前端地图与基础渲染（2-3 天）

### 目标
✅ 完成地图初始化和线路渲染  
✅ 实现 API 集成  
✅ 展示单一时间点的客流数据

### 任务清单

#### 2.1 项目结构搭建（0.5 天）
- [ ] 创建 `index.html` 模板
- [ ] 引入 Leaflet、D3.js、Day.js CDN
- [ ] 创建 CSS 样式文件
- [ ] 创建 JS 模块文件（config, api, map, main）
- [ ] 创建 Mock 数据文件

**交付物**:
- 完整的前端目录结构
- 基础 HTML/CSS

#### 2.2 地图初始化（0.5 天）
- [ ] 使用 Leaflet 初始化新加坡地图
- [ ] 添加 OpenStreetMap 底图
- [ ] 设置初始视图和边界
- [ ] 创建 MRT/LRT/Bus 图层组
- [ ] 测试地图缩放和平移

**验收标准**:
- 地图正确显示新加坡区域
- 图层组已创建

#### 2.3 API 集成（0.5 天）
- [ ] 实现 `api.js` 封装 fetch 请求
- [ ] 添加错误处理和重试逻辑
- [ ] 实现缓存机制
- [ ] 测试健康检查接口
- [ ] 加载系统元数据

**交付物**:
- 完整的 API 封装类
- 缓存功能

#### 2.4 线路渲染（1 天）
- [ ] 加载线路数据（`/api/v1/routes`）
- [ ] 使用 `L.geoJSON` 渲染线路几何
- [ ] 处理 GeoJSON ↔ Leaflet 坐标转换
- [ ] 添加线路弹窗（显示名称、类型）
- [ ] 测试所有线路是否正确显示

**验收标准**:
- 所有线路在地图上可见
- 弹窗信息正确

#### 2.5 颜色映射（0.5 天）
- [ ] 实现 `colorScale.js`
- [ ] 创建 D3 颜色比例尺
- [ ] 加载一个时间点的客流数据
- [ ] 根据客流量更新线路颜色
- [ ] 测试颜色映射效果

**验收标准**:
- 线路颜色根据客流量变化
- 颜色方案符合规范

---

## Phase 3: 时间轴与交互功能（2 天）

### 目标
✅ 实现时间轴控制  
✅ 实现图层切换  
✅ 实现动态客流更新

### 任务清单

#### 3.1 D3 时间轴组件（1 天）
- [ ] 实现 `timeline.js`
- [ ] 创建 D3 时间比例尺和轴
- [ ] 实现滑块控件
- [ ] 添加播放/暂停按钮
- [ ] 实现自动播放逻辑
- [ ] 添加时间显示
- [ ] 测试时间轴拖动和播放

**验收标准**:
- 滑块可拖动，时间显示更新
- 播放功能正常，可暂停

#### 3.2 图层控制器（0.5 天）
- [ ] 实现 `controls.js`
- [ ] 创建 MRT/LRT/Bus 切换复选框
- [ ] 监听复选框变化事件
- [ ] 调用 `map.toggleLayer()` 切换图层
- [ ] 测试图层显示/隐藏

**验收标准**:
- 复选框可独立控制图层
- 取消选中时线路消失

#### 3.3 动态更新逻辑（0.5 天）
- [ ] 绑定时间轴 `onChange` 事件
- [ ] 时间变化时调用 `/passenger-flow`
- [ ] 更新线路颜色和宽度
- [ ] 实现平滑过渡动画
- [ ] 测试连续拖动性能

**验收标准**:
- 时间变化时地图实时更新
- 动画流畅（> 30 FPS）

#### 3.4 图例组件（0.5 天）
- [ ] 实现 `legend.js`
- [ ] 创建渐变色图例
- [ ] 显示颜色映射范围
- [ ] 根据可见图层动态更新图例
- [ ] 测试图例显示

**验收标准**:
- 图例正确显示三种交通类型
- 切换图层时图例同步更新

---

## Phase 4: 优化与调试（1-2 天）

### 目标
✅ 性能优化  
✅ UI/UX 改进  
✅ 全面测试和错误处理

### 任务清单

#### 4.1 性能优化（0.5 天）
- [ ] 实现前端数据缓存（LocalStorage 或内存）
- [ ] 节流时间轴快速拖动（debounce/throttle）
- [ ] 优化大量线路渲染（Leaflet Canvas Renderer）
- [ ] 预加载下一时间点数据
- [ ] 使用 requestAnimationFrame 优化动画

**指标**:
- API 响应时间 < 500ms
- 地图更新帧率 > 30 FPS
- 内存占用 < 200MB

#### 4.2 UI/UX 改进（0.5 天）
- [ ] 响应式布局（移动端适配）
- [ ] 添加加载指示器（Spinner）
- [ ] 优化弹窗内容（显示客流量、利用率）
- [ ] 添加工具提示（Tooltip）
- [ ] 改进按钮和控件样式

**验收标准**:
- 移动端可正常使用
- 加载过程用户体验友好

#### 4.3 错误处理（0.5 天）
- [ ] 网络错误提示（API 请求失败）
- [ ] 空数据兜底（无客流数据时的处理）
- [ ] 坐标超出边界检查
- [ ] 浏览器兼容性测试（Chrome、Firefox、Safari）
- [ ] 添加错误边界（Error Boundary）

**验收标准**:
- 所有错误情况有友好提示
- 不会因错误导致页面崩溃

#### 4.4 全面测试（0.5 天）
- [ ] 功能测试（所有功能是否正常）
- [ ] 性能测试（响应时间、内存、帧率）
- [ ] 兼容性测试（多浏览器）
- [ ] 边界情况测试（超载、无数据）
- [ ] 用户体验测试

**测试清单**:
- ✅ 地图正确加载和居中
- ✅ API 请求成功
- ✅ 线路几何正确渲染
- ✅ 颜色映射符合预期
- ✅ 时间轴滑块工作
- ✅ 图层切换生效
- ✅ 自动播放流畅
- ✅ 无控制台错误

---

## 并行开发策略

前后端可以完全并行开发，以下是建议的时间安排：

| 时间 | 后端开发者 | 前端开发者 |
|-----|-----------|-----------|
| Day 1-2 | 数据清洗 + Flask 框架搭建 | 前端结构搭建 + Mock 数据 |
| Day 3 | 实现核心 API | 地图渲染 + 静态线路 |
| Day 4-5 | API 测试 + 性能优化 | 时间轴 + 交互逻辑 |
| Day 6 | 联调支持 | UI 优化 + 调试 |
| Day 7-8 | 文档完善 | 全面测试 + 部署 |

### Mock 数据使用

前端开发者在后端未就绪前，可以使用 Mock 数据独立开发：

**步骤**:
1. 在 `config.js` 中设置 `USE_MOCK_DATA: true`
2. 在 `data/mockData.js` 中定义符合 API 规范的数据
3. 正常开发，API 调用会返回 Mock 数据
4. 后端就绪后，切换 `USE_MOCK_DATA: false`

---

## 里程碑与验收

### Milestone 1: 后端 API 完成（Day 3-4）
**验收标准**:
- [ ] 所有 API 端点可访问
- [ ] 响应格式符合规范
- [ ] curl 测试全部通过

**评审**: 前端开发者测试 API，确认可以开始集成。

### Milestone 2: 前端基础渲染（Day 5-6）
**验收标准**:
- [ ] 地图显示所有线路
- [ ] 可以显示单一时间点的客流数据
- [ ] Mock 数据模式正常工作

**评审**: 后端开发者检查 API 调用是否正确。

### Milestone 3: 交互功能完成（Day 7）
**验收标准**:
- [ ] 时间轴可拖动和播放
- [ ] 图层可独立控制
- [ ] 客流数据实时更新

**评审**: 全体测试核心功能。

### Milestone 4: 项目交付（Day 8-10）
**验收标准**:
- [ ] 所有功能正常
- [ ] 性能满足要求
- [ ] 无严重 Bug
- [ ] 文档完整

---

## 协作沟通

### 日常沟通
- **每日同步**: 后端/前端开发者每天简短同步进度（5分钟）
- **问题上报**: 遇到阻塞问题立即沟通
- **代码审查**: 关键模块完成后互相审查

### 文档更新
- API 变更必须更新 `API_SPECIFICATION.md`
- 数据格式变更必须更新 `DATA_STRUCTURE.md`
- 变更必须记录版本号和日期

### 问题解决流程
1. 前端遇到 API 问题 → 在 `API_SPECIFICATION.md` 中提 Issue
2. 后端需要修改响应格式 → 通知前端并更新文档
3. 数据格式不一致 → 参考 `DATA_STRUCTURE.md` 解决

---

## 风险管理

### 潜在风险

| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| 数据获取困难 | 高 | 使用模拟数据替代 |
| API 响应慢 | 中 | 实现缓存和预加载 |
| 浏览器兼容性 | 中 | 提前测试主流浏览器 |
| 性能不达标 | 中 | 使用 Canvas Renderer |
| 时间不足 | 高 | 优先完成核心功能 |

### 应对策略
- **数据问题**: 准备一份完整的模拟数据（脚本生成）
- **性能问题**: 减少线路数量或简化几何（Phase 1 就要考虑）
- **时间压力**: 可以暂不实现站点级别聚合（Phase 2 功能）

---

## 项目自检清单

### 后端自检
- [ ] 所有 API 端点可访问
- [ ] 响应格式符合规范
- [ ] 错误处理完善
- [ ] CORS 配置正确
- [ ] 数据已预加载到内存
- [ ] 响应时间 < 500ms

### 前端自检
- [ ] 地图正确加载
- [ ] 线路渲染无误
- [ ] 时间轴可用
- [ ] 图层控制正常
- [ ] 颜色映射正确
- [ ] 无控制台错误
- [ ] 移动端可用

---

**下一步**: 根据角色阅读 `BACKEND_GUIDE.md` 或 `FRONTEND_GUIDE.md` 开始开发。
