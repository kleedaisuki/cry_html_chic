# API 接口规范
# API Specification v1.0

> **状态**: 🚧 设计中（在开发过程中逐步确定）  
> **最后更新**: 2024-12-17

---

## 📋 重要说明

本项目的 API 设计采用**渐进式开发**模式：

1. **不预先锁定所有接口**：在开发过程中根据实际需求调整
2. **以示例为指导**：提供一个完整的示例接口作为参考
3. **前后端协商**：通过文档和沟通确定最终格式
4. **逐个确定**：每个接口测试通过后才标记为"已确定"

---

## 📁 API 文档结构

所有 API 接口文档位于 `docs/api/` 目录：

```
docs/api/
├── README.md              # API 概览和开发流程
├── health.md              # ✅ 健康检查（示例，已确定）
├── metadata.md            # 📝 系统元数据（待设计）
├── routes.md              # 📝 线路数据（待设计）
└── passenger-flow.md      # 📝 客流数据（待设计，高优先级）
```

**各接口状态说明**：
- ✅ **已确定**：接口格式已锁定，不再变更
- 📝 **待设计**：草案阶段，欢迎修改
- 🚧 **开发中**：正在实现，可能微调
- ⚠️ **需讨论**：有争议，需要前后端协商

---

## 🎯 核心接口列表

| 端点 | 方法 | 用途 | 优先级 | 状态 | 文档 |
|------|------|------|--------|------|------|
| `/health` | GET | 健康检查 | 低 | ✅ 已确定 | [health.md](../docs/api/health.md) |
| `/metadata` | GET | 系统元数据 | 中 | 📝 待设计 | [metadata.md](../docs/api/metadata.md) |
| `/routes` | GET | 线路信息 | 高 | 📝 待设计 | [routes.md](../docs/api/routes.md) |
| `/passenger-flow` | GET | 客流数据 | **最高** | 📝 待设计 | [passenger-flow.md](../docs/api/passenger-flow.md) |

**优先级说明**：
- **最高**：核心功能，必须优先实现
- **高**：影响主要功能
- **中**：辅助功能
- **低**：可选功能

---

## 📖 示例：健康检查接口

这是一个完整的示例接口，其他接口可以参考这个格式编写文档。

### 快速预览

**请求**:
```bash
GET /api/v1/health
```

**响应**:
```json
{
  "status": "healthy",
  "timestamp": "2024-12-17T10:30:45",
  "version": "1.0.0",
  "data_loaded": true,
  "total_routes": 359
}
```

**完整文档**: [docs/api/health.md](../docs/api/health.md)

---

## 🔧 基础约定

这些是所有接口应该遵循的通用规范：

### API Base URL
```
http://localhost:5000/api/v1
```

### 通用规范
- **请求方法**: 主要使用 GET
- **响应格式**: JSON
- **字符编码**: UTF-8
- **时间格式**: ISO 8601 (`YYYY-MM-DDTHH:mm:ss`)
- **坐标格式**: GeoJSON ([经度, 纬度])

### 统一错误响应格式

所有错误响应应该遵循以下格式：

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "可读的错误信息",
    "details": {}
  }
}
```

**常用错误码**：
- `MISSING_PARAM` - 缺少必填参数
- `INVALID_DATETIME` - 时间格式错误
- `INVALID_TYPE` - 类型参数错误
- `NO_DATA` - 查询无结果
- `INTERNAL_ERROR` - 服务器内部错误

---

## 🚀 开发流程

### 1. 设计阶段
- [ ] 后端开发者在 `docs/api/` 创建接口文档
- [ ] 参考 `health.md` 的格式
- [ ] 包含：请求示例、响应示例、错误处理
- [ ] 通知前端开发者审查

### 2. 审查阶段
- [ ] 前端开发者审查文档
- [ ] 提出修改建议（直接在文档中标注）
- [ ] 前后端讨论并达成一致
- [ ] 更新文档状态为 🚧 开发中

### 3. 实现阶段
- [ ] 后端实现接口
- [ ] 前端创建 Mock 数据（可选）
- [ ] 前端对接真实接口
- [ ] 根据实际情况微调

### 4. 确定阶段
- [ ] 联调测试通过
- [ ] 性能达标
- [ ] 更新文档状态为 ✅ 已确定
- [ ] 接口锁定，后续不再大改

---

## 💡 API 设计建议

### 命名规范
```
✅ /passenger-flow    # 小写 + 连字符
✅ /routes            # 复数表示集合
❌ /passengerFlow     # 避免驼峰
❌ /route             # 集合应该用复数
```

### 参数设计
- 必填参数尽量少（降低使用门槛）
- 提供合理的默认值
- 参数名要清晰明确

### 响应设计
- 保持结构简单，避免过度嵌套
- 关键字段放在顶层
- 使用一致的字段命名

### 错误处理
- 使用合适的 HTTP 状态码
- 提供清晰的错误信息（中文或英文）
- 包含足够的调试信息

---

## 🔄 前后端协作

### 后端开发者职责
1. 在 `docs/api/` 下创建接口文档（复制 `health.md` 为模板）
2. 编写请求/响应示例
3. 说明参数和字段含义
4. 实现接口并提供测试 URL
5. 通知前端可以对接

### 前端开发者职责
1. 审查 API 文档设计
2. 提出修改建议或问题
3. 创建 Mock 数据（可选）
4. 对接真实 API
5. 发现问题及时反馈

### 变更管理原则
- **小改动**（字段名、类型）：直接修改文档并通知
- **大改动**（结构变化）：必须讨论后再修改
- **所有变更**：记录在文档末尾的"变更历史"

---

## 📝 快速开始指南

### 后端：设计新接口

```bash
# 1. 复制模板
cd docs/api
cp health.md new-endpoint.md

# 2. 编辑文档
# - 修改端点路径
# - 定义请求参数
# - 设计响应格式
# - 添加错误处理

# 3. 通知前端审查

# 4. 实现接口
cd ../../backend/api
# 创建对应的实现文件

# 5. 测试
curl http://localhost:5000/api/v1/new-endpoint
```

### 前端：对接接口

```bash
# 1. 阅读接口文档
cat docs/api/new-endpoint.md

# 2. 创建 Mock 数据（可选）
# 在 frontend/data/mockData.js 中添加

# 3. 在 api.js 中添加方法
# async fetchNewData() { ... }

# 4. 测试 Mock 数据
# config.js: USE_MOCK_DATA = true

# 5. 对接真实 API
# config.js: USE_MOCK_DATA = false
```

---

## 📊 接口开发进度追踪

在开发过程中，可以在这里追踪进度：

| 接口 | 文档编写 | 前端审查 | 后端实现 | 前端对接 | 测试 | 状态 |
|------|---------|---------|---------|---------|------|------|
| health | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ 已确定 |
| metadata | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | 📝 待开始 |
| routes | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | 📝 待开始 |
| passenger-flow | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | 📝 待开始 |

**更新方式**：开发者完成对应步骤后，将 ⬜ 改为 ✅

---

## 🎓 参考资源

### API 设计最佳实践
- [RESTful API 设计指南](https://restfulapi.net/)
- [HTTP 状态码速查](https://httpstatuses.com/)
- [JSON API 规范](https://jsonapi.org/)

### 工具推荐
- **测试工具**: curl, Postman, HTTPie
- **文档工具**: Swagger/OpenAPI (可选)
- **Mock 服务**: json-server (可选)

---

## 📞 遇到问题？

### 前端遇到 API 问题
1. 检查文档 `docs/api/<endpoint>.md`
2. 确认请求格式是否正确
3. 查看浏览器 Network 面板
4. 联系后端开发者

### 后端不确定如何设计
1. 参考 `docs/api/health.md` 示例
2. 查看 `DATA_STRUCTURE.md` 了解数据格式
3. 与前端开发者讨论需求

### 需要修改已确定的接口
1. 评估影响范围
2. 与团队讨论
3. 更新文档并标注破坏性变更
4. 通知所有相关开发者

---

## 变更日志

| 日期 | 版本 | 变更内容 | 负责人 |
|------|------|----------|--------|
| 2024-12-17 | 1.0 | 改为渐进式 API 设计，创建独立文档结构 | Jingren |

---

**下一步**：
- 后端：开始设计 `/passenger-flow` 接口（最高优先级）
- 前端：阅读 `docs/api/README.md` 了解开发流程
- 全体：遇到问题随时沟通

---

**相关文档**：
- [API 文档目录](../docs/api/README.md)
- [数据结构规范](./DATA_STRUCTURE.md)
- [后端开发指南](./BACKEND_GUIDE.md)
- [前端开发指南](./FRONTEND_GUIDE.md)
