# 客流数据接口
# Passenger Flow API

> **端点**: `GET /api/v1/passenger-flow`  
> **状态**: 📝 待设计（核心接口，优先级高）  
> **最后更新**: 2024-12-17

---

## 🚧 开发说明

这是系统最核心的接口，时间轴播放会频繁调用。**请优先设计和实现**。

---

## 接口概述

根据时间查询所有线路的客流量数据。

**用途**：
- 时间轴播放时动态更新地图
- 显示每条线路的客流量
- 根据客流量改变线路颜色

---

## 需要包含的信息（草案）

### 必须有的
- 线路 ID（与 routes 接口对应）
- 客流量（人次/小时）
- 时间戳

### 可选的
- 容量利用率
- 进站/出站分布
- 是否超载

---

## 请求示例（草案）

```bash
# 必填参数：时间
GET /api/v1/passenger-flow?datetime=2024-01-01T08:00:00

# 可选参数：交通类型过滤
GET /api/v1/passenger-flow?datetime=2024-01-01T08:00:00&types=mrt,lrt
```

---

## 响应示例（草案）

```json
{
  "timestamp": "2024-01-01T08:00:00",
  "data": [
    {
      "route_id": "NS_LINE",
      "type": "mrt",
      "flow": 8500,
      "capacity": 12000,
      "utilization": 0.708
    },
    {
      "route_id": "EW_LINE",
      "type": "mrt",
      "flow": 9210,
      "capacity": 12000,
      "utilization": 0.768
    }
  ],
  "total_flow": 78543
}
```

---

## 待讨论的问题

- [ ] 时间格式是否必须精确到秒？还是只需要小时？
- [ ] 如果查询的时间点没有数据，返回什么？
- [ ] 是否需要返回方向信息（进城/出城）？
- [ ] 是否需要支持站点级别的聚合？
- [ ] 超载时（utilization > 1）如何处理？
- [ ] 是否需要缓存提示（告诉前端可以缓存多久）？

---

## 性能要求

这是高频调用的接口，性能要求较高：
- **响应时间**: < 500ms（目标 < 300ms）
- **并发支持**: 50 req/s
- **数据预加载**: 建议启动时加载所有数据到内存

---

## 错误处理

### 缺少 datetime 参数
```json
{
  "error": {
    "code": "MISSING_PARAM",
    "message": "缺少必填参数 'datetime'"
  }
}
```

### 时间格式错误
```json
{
  "error": {
    "code": "INVALID_DATETIME",
    "message": "时间格式错误，应为 ISO 8601 格式"
  }
}
```

### 无数据
```json
{
  "error": {
    "code": "NO_DATA",
    "message": "指定时间无数据"
  }
}
```

---

## 实现建议

### 后端
- 使用 Pandas 预处理和聚合数据
- 启动时加载到内存（DataFrame）
- 使用时间索引快速查询
- 考虑实现缓存

### 前端
- 实现前端缓存（已查询的时间点）
- 节流时间轴快速拖动
- 预加载相邻时间点数据

---

## 优化方案

如果性能不达标，可以考虑：

1. **数据格式优化**
   - 使用 Parquet 替代 CSV
   - 建立时间索引

2. **缓存策略**
   - 后端 LRU 缓存
   - 前端 LocalStorage 缓存

3. **数据粒度**
   - 降低时间粒度（小时 → 天）
   - 减少线路数量

---

## 变更历史

| 日期 | 版本 | 变更内容 | 负责人 |
|------|------|----------|--------|
| 2024-12-17 | 0.1 | 创建草案，标记为高优先级 | Jingren |

---

**待办**: 
- 后端：请优先完善此文档并实现
- 前端：准备好 Mock 数据以便独立开发
