# 前端开发目标

实现对后端已经获取并进行数据清理的数据进行可视化展示

主要支持：
- 新加坡主要公共交通线路的可视化支持
- 每条公交线路在地图上的高亮展示
- 支持用户交互，展示对应时间节点的数据，有一个全局时间轴可以控制当前时间
- 支持不同交通线路，由于客流承载力不同，使用不同的数据范围进行可视化展示
- 支持侧边栏或者是弹出窗口，展示用户选中的公共交通线路的详细信息，包括但不限于，线路名称，起点终点站点，途径站点的单站点客流量，时间发展历程等信息

---

## 一、UI 设计规范

### 1.1 布局风格
- **悬浮控件模式**：地图全屏 + 悬浮控制面板
- **配色主题**：自动切换（深色/浅色模式）
- **数据来源**：静态 JS 文件（`data/preprocessed/`）

### 1.2 布局结构

```
+--------------------------------------------------+
|  [Logo]  标题                         [主题切换] |
+--------------------------------------------------+
|  [+][-]                               [时间显示] |
|            +-------------------------+          |
|            |                         |          |
|            |                         |          |
|            |       地图区域          |  <-- 悬浮 |
|            |                         |     详情 |
|            |                         |    侧边栏|
|            +-------------------------+          |
|                                                  |
|  +--------------------------------------------+  |
|  |  时间轴组件（拖拽条 + 播放控制）            |  |
|  +--------------------------------------------+  |
|                                                  |
|  [+][-]  图层控制    [MRT][LRT][Bus]            |
+--------------------------------------------------+
```

### 1.3 配色方案

| 交通类型 | 颜色范围 | D3 插值器 | 主题说明 |
|---------|---------|-----------|---------|
| MRT | 0 - 12000 | `d3.interpolateBlues` | 浅蓝→深蓝 |
| LRT | 0 - 3500 | `d3.interpolateGreens` | 浅绿→深绿 |
| Bus | 0 - 800 | `d3.interpolateOranges` | 浅橙→深橙 |

### 1.4 CSS 主题变量

```css
/* theme-light.css */
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --text-primary: #1a1a1a;
  --text-secondary: #666666;
  --border-color: #e0e0e0;
  --shadow: 0 2px 8px rgba(0,0,0,0.1);
  --panel-bg: rgba(255,255,255,0.95);
}

/* theme-dark.css */
:root {
  --bg-primary: #1a1a1a;
  --bg-secondary: #2a2a2a;
  --text-primary: #ffffff;
  --text-secondary: #a0a0a0;
  --border-color: #404040;
  --shadow: 0 2px 8px rgba(0,0,0,0.4);
  --panel-bg: rgba(30,30,30,0.95);
}
```

---

## 二、目录结构

```
frontend/
├── index.html              # 入口文件
├── css/
│   ├── main.css           # 主样式
│   ├── theme-light.css    # 浅色主题
│   └── theme-dark.css     # 深色主题
├── js/
│   ├── config.js          # 配置文件
│   ├── api.js             # 数据加载模块
│   ├── map/
│   │   ├── map.js         # Leaflet 地图初始化
│   │   └── layers.js      # 交通线路图层管理
│   ├── visualization/
│   │   ├── colorScale.js  # D3 颜色比例尺
│   │   └── flowRenderer.js # 客流可视化渲染
│   ├── timeline/
│   │   ├── timeline.js    # D3 时间轴组件
│   │   └── player.js      # 播放控制器
│   ├── ui/
│   │   ├── panel.js       # 悬浮控制面板
│   │   ├── sidebar.js     # 详情侧边栏
│   │   └── tooltip.js     # 悬浮提示框
│   ├── utils/
│   │   ├── dayjs.js       # Day.js（本地副本）
│   │   └── helpers.js     # 工具函数
│   └── main.js            # 应用入口
└── assets/
    └── icons/             # 图标资源
```

---

## 三、开发任务清单

### 阶段一：基础框架（P0）

| 任务ID | 文件 | 描述 | 优先级 |
|--------|------|------|--------|
| T1.1 | `index.html` | 创建入口文件骨架（地图容器 + 控制面板占位） | P0 |
| T1.2 | `css/main.css` | 主样式文件（布局 + 基础组件） | P0 |
| T1.3 | `css/theme-light.css` | 浅色主题 | P0 |
| T1.4 | `css/theme-dark.css` | 深色主题 | P0 |
| T1.5 | `js/config.js` | 配置文件（数据路径、默认配置） | P0 |
| T1.6 | `js/main.js` | 应用入口、初始化流程 | P0 |
| T1.7 | `js/utils/dayjs.js` | Day.js 本地库 | P0 |
| T1.8 | `js/utils/helpers.js` | 通用工具函数 | P1 |

### 阶段二：地图模块（P0）

| 任务ID | 文件 | 描述 | 优先级 |
|--------|------|------|--------|
| T2.1 | `js/map/map.js` | Leaflet 地图初始化（新加坡中心坐标） | P0 |
| T2.2 | `js/map/layers.js` | 交通线路 GeoJSON 图层加载 | P0 |
| T2.3 | `js/map/map.js` | OpenStreetMap / CartoDB 底图集成 | P0 |
| T2.4 | `js/map/map.js` | 深色/浅色底图切换 | P1 |
| T2.5 | `js/map/layers.js` | 地图缩放/平移控件 | P1 |

### 阶段三：客流可视化（P0）

| 任务ID | 文件 | 描述 | 优先级 |
|--------|------|------|--------|
| T3.1 | `js/visualization/colorScale.js` | D3 颜色比例尺实现 | P0 |
| T3.2 | `js/visualization/flowRenderer.js` | 根据客流数据动态设置线路颜色 | P0 |
| T3.3 | `js/visualization/colorScale.js` | 图例组件（颜色映射说明） | P1 |
| T3.4 | `js/visualization/colorScale.js` | 图例主题切换支持 | P1 |
| T3.5 | `js/visualization/flowRenderer.js` | 颜色渐变动画效果 | P2 |

### 阶段四：时间轴模块（P0）

| 任务ID | 文件 | 描述 | 优先级 |
|--------|------|------|--------|
| T4.1 | `js/timeline/timeline.js` | D3 时间轴组件 | P0 |
| T4.2 | `js/timeline/timeline.js` | 时间刻度与格式化 | P0 |
| T4.3 | `js/timeline/timeline.js` | 拖拽选择时间功能 | P0 |
| T4.4 | `js/timeline/player.js` | 播放/暂停/停止控制 | P1 |
| T4.5 | `js/timeline/player.js` | 播放速度调节 | P2 |
| T4.6 | `js/timeline/player.js` | 时间循环播放 | P2 |

### 阶段五：交互模块（P0）

| 任务ID | 文件 | 描述 | 优先级 |
|--------|------|------|--------|
| T5.1 | `js/ui/sidebar.js` | 详情侧边栏显示线路信息 | P0 |
| T5.2 | `js/map/layers.js` | 线路点击事件处理 | P0 |
| T5.3 | `js/ui/tooltip.js` | 悬浮提示框显示线路名称 | P1 |
| T5.4 | `js/ui/sidebar.js` | 侧边栏内容：线路名称、起终点、站点列表 | P1 |
| T5.5 | `js/ui/sidebar.js` | 侧边栏时间序列图表 | P2 |
| T5.6 | `js/ui/sidebar.js` | 侧边栏客流统计卡片 | P2 |

### 阶段六：悬浮控件面板（P1）

| 任务ID | 文件 | 描述 | 优先级 |
|--------|------|------|--------|
| T6.1 | `js/ui/panel.js` | 悬浮控制面板组件 | P0 |
| T6.2 | `js/map/layers.js` | MRT/LRT/Bus 图层显隐开关 | P1 |
| T6.3 | `js/ui/panel.js` | 透明度滑块 | P2 |
| T6.4 | `js/map/layers.js` | 图层叠加顺序控制 | P2 |

### 阶段七：数据与 API（P0）

| 任务ID | 文件 | 描述 | 优先级 |
|--------|------|------|--------|
| T7.1 | `js/api.js` | 从 `data/preprocessed/` 加载 JS 常量 | P0 |
| T7.2 | `js/api.js` | 客流数据解析与缓存 | P0 |
| T7.3 | `js/api.js` | 线路数据解析与缓存 | P0 |

### 阶段八：性能优化（P2）

| 任务ID | 文件 | 描述 | 优先级 |
|--------|------|------|--------|
| T8.1 | `js/api.js` | 数据预加载机制 | P2 |
| T8.2 | `js/visualization/flowRenderer.js` | Canvas 渲染选项 | P2 |
| T8.3 | `js/api.js` | 数据缓存机制 | P2 |
| T8.4 | `js/utils/helpers.js` | 响应式适配 | P2 |

---

## 四、数据接口格式

### 4.1 客流数据（前端 API 格式）

```javascript
// data/preprocessed/*/passenger_flow.js
window.PASSENGER_FLOW = {
  "ir_kind": "passenger_flow",
  "data": {
    "2024-01-01T07": {
      "timestamp": "2024-01-01T07",
      "data": [
        {
          "route_id": "NS_LINE",
          "type": "mrt",
          "flow": 8500,
          "capacity": 12000,
          "utilization": 0.708
        },
        {
          "route_id": "EW_LINE",
          "type": "mrt",
          "flow": 9200,
          "capacity": 12000,
          "utilization": 0.767
        }
        // ...
      ],
      "total_flow": 78543
    }
    // ...
  }
};
```

### 4.2 线路数据（待后端定义）

```javascript
// data/preprocessed/*/routes.js
window.ROUTES = {
  "NS_LINE": {
    "name": "North-South Line",
    "type": "mrt",
    "coordinates": [[103.82, 1.35], ...],  // GeoJSON LineString
    "stations": [
      {"id": "NS1", "name": "Jurong East", "position": [103.82, 1.36]},
      // ...
    ]
  }
};
```

---

## 五、里程碑

| 里程碑 | 目标 | 核心产出 | 包含任务 |
|--------|------|----------|---------|
| M1 | 基础框架 | 地图显示 + 主题切换 | T1.1-T1.7, T2.1, T2.3 |
| M2 | 数据可视化 | 线路颜色随客流变化 | T2.2, T3.1, T3.2, T7.1, T7.2 |
| M3 | 时间轴控制 | 可拖拽时间轴 + 播放 | T4.1-T4.4 |
| M4 | 完整交互 | 点击线路显示详情 | T2.5, T5.1, T5.2, T5.3, T6.1 |
| M5 | 优化完善 | 性能优化 + 响应式 | T8.1-T8.4 |

---

## 六、技术栈

- Vanilla JavaScript（无框架）
- Leaflet.js（地图渲染）
- D3.js（数据可视化 + 时间轴）
- Day.js（时间处理）

---

## 七、参考资源

- [Leaflet.js 文档](https://leafletjs.com/reference.html)
- [D3.js 文档](https://d3js.org/)
- [Day.js 文档](https://day.js.org/)
- [RESTful API 设计指南](https://restfulapi.net/)

---

*文档版本: v2.0*
*创建日期: 2026-01-01*